<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
        <title>Sponsor/Adoption of Animal</title>
    
        <!-- Bootstrap -->
        <link href="css/bootstrap.min.css" rel="stylesheet">
    
        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
      </head>
      <body>
        <div class="container">
          <div class="row">
            <div class="col-xs-12 col-sm-8 col-sm-push-2">
              <h1 class="text-center">Sponsor/Adoption of Animal, Zoo Negara </h1>
              <hr/>
              <br/>
            </div>
          </div>
    
          <div id="animalsRow" class="row">
            <!-- ANIMALS LOAD HERE -->
          </div>
        </div>
    
        <div id="animalsTemplate" style="display: none;">
          <div class="col-sm-6 col-md-4 col-lg-3">
            <div class="panel panel-default panel-pet">
              <div class="panel-heading">
                <h3 class="panel-title">Scrappy</h3>
              </div>
              <div class="panel-body">
                <img alt="140x140" data-src="holder.js/140x140" class="img-rounded img-center" style="width: 100%;" src="  " data-holder-rendered="true">
                <br/><br/>
                <strong>Fee</strong>: <span class="animals-fee">Animal</span><br/>
                <strong>Age</strong>: <span class="animals-age">3</span><br/>
                <strong>Location</strong>: <span class="animals-location">Location</span><br/><br/>
                <button class="btn btn-default btn-adopt" type="button" data-id="0">Adopt</button>
              </div>
            </div>
          </div>
        </div>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
        <script src="js/web3.min.js"></script>
        <script src="js/truffle-contract.js"></script>
        <script>
        App = {
  web3Provider: null,
  contracts: {},

  init: async function() {
    // Load animals.
    $.getJSON('../Animals.json', function(data) {
      var animalsRow = $('#animalsRow');
      var animalsTemplate = $('#animalsTemplate');

      for (i = 0; i < data.length; i ++) {
        animalsTemplate.find('.panel-title').text(data[i].name);
        animalsTemplate.find('img').attr('src', data[i].picture);
        animalsTemplate.find('.animals-fee').text(data[i].fee);
        animalsTemplate.find('.animals-age').text(data[i].age);
        animalsTemplate.find('.animals-location').text(data[i].location);
        animalsTemplate.find('.btn-adopt').attr('data-id', data[i].id);

        animalsRow.append(animalsTemplate.html());
      }
    });

    return await App.initWeb3();
  },

  initWeb3: async function() {
    
    if (window.ethereum) {
      App.web3Provider = window.ethereum;
      try {
        // Request account access
        await window.ethereum.request({ method: "eth_requestAccounts" });;
      } catch (error) {
        // User denied account access...
        console.error("User denied account access")
      }
    }
    // Legacy dapp browsers...
    else if (window.web3) {

      App.web3Provider = window.web3.currentProvider;
    }
    // If no injected web3 instance is detected, fall back to Ganache
    else {
      App.web3Provider = new Web3.providers.HttpProvider('http://localhost:9545');
    }
    web3 = new Web3(App.web3Provider);

    return App.initContract();
  },

  initContract: function() {
    $.getJSON('../deployment/build/contracts/Dex.json', function(data) {
      // Get the necessary contract artifact file and instantiate it with @truffle/contract
      var AdoptionArtifact = data;
      App.contracts.Adoption = TruffleContract(AdoptionArtifact);
    
      // Set the provider for our contract
      App.contracts.Adoption.setProvider(App.web3Provider);
    
      // Use our contract to retrieve and mark the adopted animals
      return App.markAdopted();
    });
    return App.bindEvents();
  },

  bindEvents: function() {
    $(document).on('click', '.btn-adopt', App.handleAdopt);
  },

  markAdopted: function() {
    var adoptionInstance;

    App.contracts.Adoption.deployed().then(function(instance) {
      adoptionInstance = instance;
    
      return adoptionInstance.getAdopters.call();
    }).then(function(adopters) {
      for (i = 0; i < adopters.length; i++) {
        if (adopters[i] !== '0x0000000000000000000000000000000000000000') {
          $('.panel-pet').eq(i).find('button').text('Success').attr('disabled', true);
        }
      }
    }).catch(function(err) {
      console.log(err.message);
    });

  },

  handleAdopt: function(event) {
    event.preventDefault();

    var animalId = parseInt($(event.target).data('id'));
    var adoptionInstance;

    web3.eth.getAccounts(function(error, accounts) {
    if (error) {
      console.log(error);
    }

  var account = accounts[0];

   App.contracts.Adoption.deployed().then(function(instance) {
      adoptionInstance = instance;

      // Execute adopt as a transaction by sending account
      return adoptionInstance.adopt(animalId, {from: account});
    }).then(function(result) {
      return App.markAdopted();
    }).catch(function(err) {
      console.log(err.message);
    });
  });

  }

};

$(function() {
  $(window).load(function() {
    App.init();
  });
});

    </script>
    </body>